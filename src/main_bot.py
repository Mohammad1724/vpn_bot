# main_bot.py (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ø³ÛŒØ³ØªÙ… Ø´Ø§Ø±Ú˜)

import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes, ConversationHandler

import database as db
import hiddify_api
from config import BOT_TOKEN, ADMIN_ID

# Enable logging
logging.basicConfig(format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO)
logger = logging.getLogger(__name__)

# States for Conversations
# Admin Add Plan states
PLAN_NAME, PLAN_PRICE, PLAN_DAYS, PLAN_GB = range(4)
# User Charge Wallet states
CHARGE_AMOUNT, CHARGE_RECEIPT = range(4, 6)

# --- Helper Functions ---
async def send_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    db.get_or_create_user(user_id)
    keyboard = [["ğŸ›ï¸ Ø®Ø±ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³"], ["ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨", "ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"]]
    if user_id == ADMIN_ID:
        keyboard.append(["ğŸ‘‘ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†"])
    await update.message.reply_text("Ù„Ø·ÙØ§ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))

# --- User Commands ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ‘‹ Ø¨Ù‡ Ø±Ø¨Ø§Øª ÙØ±ÙˆØ´ VPN Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!")
    await send_main_menu(update, context)

async def show_balance(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = db.get_or_create_user(update.effective_user.id)
    keyboard = [[InlineKeyboardButton("ğŸ’³ Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨", callback_data="start_charge")]]
    await update.message.reply_text(
        f"ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§: **{user['balance']:.0f}** ØªÙˆÙ…Ø§Ù†",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

async def show_support(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Ø¬Ù‡Øª Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ù‡ Ø¢ÛŒØ¯ÛŒ Ø²ÛŒØ± Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n@YOUR_SUPPORT_USERNAME")

async def buy_service_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    plans = db.list_plans()
    if not plans:
        await update.message.reply_text("Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù‡ÛŒÚ† Ù¾Ù„Ù†ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.")
        return
    keyboard = [[InlineKeyboardButton(f"{p['name']} - {p['days']} Ø±ÙˆØ²Ù‡ {p['gb']} Ú¯ÛŒÚ¯ - {p['price']:.0f} ØªÙˆÙ…Ø§Ù†", callback_data=f"buy_{p['plan_id']}")] for p in plans]
    await update.message.reply_text("Ù„Ø·ÙØ§ Ø³Ø±ÙˆÛŒØ³ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", reply_markup=InlineKeyboardMarkup(keyboard))

# --- Charge Wallet Conversation ---
async def charge_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await query.message.reply_text("Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„ØºÛŒ Ú©Ù‡ Ù‚ØµØ¯ ÙˆØ§Ø±ÛŒØ² Ø¢Ù† Ø±Ø§ Ø¯Ø§Ø±ÛŒØ¯ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (ÙÙ‚Ø· Ø¹Ø¯Ø¯):")
    return CHARGE_AMOUNT

async def charge_amount_received(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        amount = int(update.message.text)
        if amount <= 0:
            raise ValueError
        context.user_data['charge_amount'] = amount
        card_number = "1234-5678-9012-3456" # <<<< Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
        await update.message.reply_text(
            f"Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº **{amount:,} ØªÙˆÙ…Ø§Ù†** Ø±Ø§ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø²ÛŒØ± ÙˆØ§Ø±ÛŒØ² Ù†Ù…Ø§ÛŒÛŒØ¯:\n\n`{card_number}`\n\n"
            "Ø³Ù¾Ø³ Ø§Ø² Ø±Ø³ÛŒØ¯ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø®ÙˆØ¯ Ø¹Ú©Ø³ Ú¯Ø±ÙØªÙ‡ Ùˆ Ø¢Ù† Ø±Ø§ Ø¯Ø± Ù‡Ù…ÛŒÙ† ØµÙØ­Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
            parse_mode='Markdown'
        )
        return CHARGE_RECEIPT
    except ValueError:
        await update.message.reply_text("Ù„Ø·ÙØ§ ÛŒÚ© Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ Ùˆ Ù…Ø«Ø¨Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
        return CHARGE_AMOUNT

async def charge_receipt_received(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    amount = context.user_data['charge_amount']
    receipt_photo = update.message.photo[-1]  # Get the highest resolution photo

    # Forward the receipt to the admin
    caption = (
        f"Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ Ø¬Ø¯ÛŒØ¯ ğŸ””\n\n"
        f"Ú©Ø§Ø±Ø¨Ø±: {user.full_name} (@{user.username})\n"
        f"Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ: `{user.id}`\n"
        f"Ù…Ø¨Ù„Øº Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ: **{amount:,} ØªÙˆÙ…Ø§Ù†**\n\n"
        "Ù„Ø·ÙØ§ Ù¾Ø³ Ø§Ø² Ø¨Ø±Ø±Ø³ÛŒØŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ØªØ§ÛŒÛŒØ¯ ÛŒØ§ Ø±Ø¯ Ú©Ù†ÛŒØ¯."
    )
    keyboard = [
        [
            InlineKeyboardButton("âœ… ØªØ§ÛŒÛŒØ¯ Ø´Ø§Ø±Ú˜", callback_data=f"confirm_charge_{user.id}_{amount}"),
            InlineKeyboardButton("âŒ Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª", callback_data=f"reject_charge_{user.id}")
        ]
    ]
    await context.bot.send_photo(
        chat_id=ADMIN_ID,
        photo=receipt_photo.file_id,
        caption=caption,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )
    
    await update.message.reply_text("âœ… Ø±Ø³ÛŒØ¯ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ ØªØ§ Ø²Ù…Ø§Ù† Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªØ§ÛŒÛŒØ¯ ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ† Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯.")
    context.user_data.clear()
    return ConversationHandler.END

async def cancel_charge(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Ø¹Ù…Ù„ÛŒØ§Øª Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨ Ù„ØºÙˆ Ø´Ø¯.")
    context.user_data.clear()
    return ConversationHandler.END


# --- Callback Query Handler (Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ) ---
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    data = query.data.split('_')
    action = data[0]

    if action == "start" and data[1] == "charge":
        # Ø§ÛŒÙ† Ø¯Ú©Ù…Ù‡ Ù…Ú©Ø§Ù„Ù…Ù‡ Ø´Ø§Ø±Ú˜ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ ØªÙˆØ³Ø· ConversationHandler Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯
        # Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„ØŒ Ø§ÛŒÙ†Ø¬Ø§ Ú©Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….
        return
        
    if action == "buy":
        # ... (Ú©Ø¯ Ø®Ø±ÛŒØ¯ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯) ...
        plan = db.get_plan(int(data[1]))
        user = db.get_or_create_user(user_id)
        if not plan: await query.edit_message_text("âŒ Ø§ÛŒÙ† Ù¾Ù„Ù† Ø¯ÛŒÚ¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª."); return
        if user['balance'] < plan['price']: await query.edit_message_text(f"Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø´Ù…Ø§ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!\nÙ…ÙˆØ¬ÙˆØ¯ÛŒ: {user['balance']:.0f} ØªÙˆÙ…Ø§Ù†\nÙ‚ÛŒÙ…Øª Ù¾Ù„Ù†: {plan['price']:.0f} ØªÙˆÙ…Ø§Ù†"); return
        await query.edit_message_text("Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ø³Ø±ÙˆÛŒØ³ Ø´Ù…Ø§... Ù„Ø·ÙØ§ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯. â³")
        link = hiddify_api.create_hiddify_user(plan['days'], plan['gb'], user_id)
        if link:
            db.update_balance(user_id, -plan['price'])
            await query.edit_message_text(f"âœ… Ø³Ø±ÙˆÛŒØ³ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!\n\nÙ„ÛŒÙ†Ú© Ø§ØªØµØ§Ù„ Ø´Ù…Ø§:\n`{link}`\n\nØ¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú©ØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ú©Ù¾ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.", parse_mode='Markdown')
        else: await query.edit_message_text("âŒ Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø³Ø§Ø®Øª Ø³Ø±ÙˆÛŒØ³ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ù„Ø·ÙØ§ Ø¨Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹ Ø¯Ù‡ÛŒØ¯.")
    
    elif action == "delete" and user_id == ADMIN_ID:
        db.delete_plan(int(data[1]))
        await query.edit_message_text("Ù¾Ù„Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.")

    elif action == "confirm" and user_id == ADMIN_ID:
        target_user_id = int(data[2])
        amount = int(data[3])
        db.update_balance(target_user_id, amount)
        await query.edit_message_text(f"âœ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ø¨Ù„Øº {amount:,} ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ {target_user_id} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.")
        await context.bot.send_message(
            chat_id=target_user_id,
            text=f"Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù…Ø¨Ù„Øº **{amount:,} ØªÙˆÙ…Ø§Ù†** Ø´Ø§Ø±Ú˜ Ø´Ø¯!",
            parse_mode='Markdown'
        )

    elif action == "reject" and user_id == ADMIN_ID:
        target_user_id = int(data[2])
        await query.edit_message_text(f"âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ Ú©Ø§Ø±Ø¨Ø± {target_user_id} Ø±Ø¯ Ø´Ø¯.")
        await context.bot.send_message(
            chat_id=target_user_id,
            text="Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ† Ø±Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ø± ØªÙ…Ø§Ø³ Ø¨Ø§Ø´ÛŒØ¯."
        )


# --- Admin Functions (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) ---
# ... (ØªÙ…Ø§Ù… ØªÙˆØ§Ø¨Ø¹ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø² admin_panel ØªØ§ cancel_conversation Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù†Ø¯) ...
async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [["â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù† Ø¬Ø¯ÛŒØ¯", "ğŸ“‹ Ù„ÛŒØ³Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§"],["â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ"]]
    await update.message.reply_text("ğŸ‘‘ Ø¨Ù‡ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))
async def add_plan_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Ù„Ø·ÙØ§ Ù†Ø§Ù… Ù¾Ù„Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", reply_markup=ReplyKeyboardMarkup([["Ù„ØºÙˆ"]], resize_keyboard=True))
    return PLAN_NAME
async def plan_name_received(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['plan_name'] = update.message.text
    await update.message.reply_text("Ù†Ø§Ù… Ø«Ø¨Øª Ø´Ø¯. Ù‚ÛŒÙ…Øª Ø±Ø§ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"); return PLAN_PRICE
async def plan_price_received(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try: context.user_data['plan_price'] = float(update.message.text); await update.message.reply_text("Ù‚ÛŒÙ…Øª Ø«Ø¨Øª Ø´Ø¯. ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"); return PLAN_DAYS
    except ValueError: await update.message.reply_text("Ù„Ø·ÙØ§ Ù‚ÛŒÙ…Øª Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return PLAN_PRICE
async def plan_days_received(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try: context.user_data['plan_days'] = int(update.message.text); await update.message.reply_text("ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø«Ø¨Øª Ø´Ø¯. Ø­Ø¬Ù… Ø³Ø±ÙˆÛŒØ³ Ø¨Ù‡ Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"); return PLAN_GB
    except ValueError: await update.message.reply_text("Ù„Ø·ÙØ§ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return PLAN_DAYS
async def plan_gb_received(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        context.user_data['plan_gb'] = int(update.message.text)
        db.add_plan(context.user_data['plan_name'], context.user_data['plan_price'], context.user_data['plan_days'], context.user_data['plan_gb'])
        await update.message.reply_text("âœ… Ù¾Ù„Ù† Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!")
        context.user_data.clear(); await admin_panel(update, context); return ConversationHandler.END
    except ValueError: await update.message.reply_text("Ù„Ø·ÙØ§ Ø­Ø¬Ù… Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return PLAN_GB
async def list_plans_admin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    plans = db.list_plans()
    if not plans: await update.message.reply_text("Ù‡ÛŒÚ† Ù¾Ù„Ù†ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡."); return
    await update.message.reply_text("Ù„ÛŒØ³Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§:")
    for p in plans:
        text = f"ğŸ”¹ **{p['name']}** (ID: `{p['plan_id']}`)\n   - Ù‚ÛŒÙ…Øª: {p['price']:.0f} ØªÙˆÙ…Ø§Ù†\n   - Ù…Ø´Ø®ØµØ§Øª: {p['days']} Ø±ÙˆØ²Ù‡ / {p['gb']} Ú¯ÛŒÚ¯"
        await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("ğŸ—‘ï¸ Ø­Ø°Ù", callback_data=f"delete_{p['plan_id']}")]]) , parse_mode='Markdown')
async def cancel_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯."); context.user_data.clear(); await admin_panel(update, context); return ConversationHandler.END


def main():
    db.init_db()
    application = Application.builder().token(BOT_TOKEN).build()
    
    admin_filter = filters.User(user_id=ADMIN_ID)
    
    # Conversation handler Ø¨Ø±Ø§ÛŒ Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨
    charge_conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(charge_start, pattern='^start_charge$')],
        states={
            CHARGE_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, charge_amount_received)],
            CHARGE_RECEIPT: [MessageHandler(filters.PHOTO, charge_receipt_received)],
        },
        fallbacks=[CommandHandler('cancel', cancel_charge)],
    )

    # Conversation handler Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù† (ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†)
    add_plan_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex('^â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù† Ø¬Ø¯ÛŒØ¯$') & admin_filter, add_plan_start)],
        states={
            PLAN_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND & admin_filter, plan_name_received)],
            PLAN_PRICE: [MessageHandler(filters.TEXT & ~filters.COMMAND & admin_filter, plan_price_received)],
            PLAN_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND & admin_filter, plan_days_received)],
            PLAN_GB: [MessageHandler(filters.TEXT & ~filters.COMMAND & admin_filter, plan_gb_received)],
        },
        fallbacks=[MessageHandler(filters.Regex('^Ù„ØºÙˆ$') & admin_filter, cancel_conversation)],
    )

    # Ø«Ø¨Øª Ú©Ù†ØªØ±Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§
    application.add_handler(CommandHandler("start", start))
    application.add_handler(charge_conv_handler)
    application.add_handler(add_plan_handler)
    application.add_handler(CallbackQueryHandler(button_handler))
    
    # Ú©Ù†ØªØ±Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
    application.add_handler(MessageHandler(filters.Regex('^ğŸ›ï¸ Ø®Ø±ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³$'), buy_service_list))
    application.add_handler(MessageHandler(filters.Regex('^ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ø´Ø§Ø±Ú˜ Ø­Ø³Ø§Ø¨$'), show_balance))
    application.add_handler(MessageHandler(filters.Regex('^ğŸ“ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ$'), show_support))
    application.add_handler(MessageHandler(filters.Regex('^ğŸ‘‘ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†$') & admin_filter, admin_panel))
    application.add_handler(MessageHandler(filters.Regex('^ğŸ“‹ Ù„ÛŒØ³Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§$') & admin_filter, list_plans_admin))
    application.add_handler(MessageHandler(filters.Regex('^â†©ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ$') & admin_filter, start))
    
    print("Bot is running...")
    application.run_polling()

if __name__ == "__main__":
    main()
